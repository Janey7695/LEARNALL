### 一、C51的串行口结构
[![](http://112.124.31.67/wp-content/uploads/2020/07/wp_editor_md_1ad302a3ea25c23d43d66ed40573cbd1.jpg)](http://112.124.31.67/wp-content/uploads/2020/07/wp_editor_md_1ad302a3ea25c23d43d66ed40573cbd1.jpg)

结构上他有2个独立的物理上的接收、发送缓冲器SBUF,它们占用同一个地址99H；接收器是双缓冲结构，发送缓冲器因为发送是cpu主动进行的，因此不会产生重叠错误。

串口结构内部还有一个定时器，串口的波特率就是通过T1溢出率来决定的。

### 二、80C51串行口的控制寄存器——SCON

|位|7|6|5|4|3|2|1|0||
|---|---|---|---|---|---|---|---|---|---|
|字节地址：98H|SM0|SM1|SM2|REN|TB8|RB8|TI|RI|SCON|

用来设置串口的工作方式、接收/发送控制以及设置状态位

>SM0和SM1为工作方式选择位，可以选择四种工作方式：

|SM0|SM1|方式|说明|波特率|
|---|---|---|---|---|
|0|0|0|移位寄存器|fosc/12|
|0|1|1|10位异步收发器（8位数据）|可变|
|1|0|2|11位异步收发器（9位数据）|fosc/64或fosc/32|
|1|1|3|11位异步收发器（9位数据）|可变|

1. 方式0
方式0时，串行口是同步移位寄存器的输入输出方式，数据由RXD（P30）引脚输入或输出，同步脉冲由TXD（p31）引脚输出。波特率固定fosc/12。

2. 方式1
方式1是10位数据的异步通信口，TXD位数据发送引脚，RXD为数据接收引脚，传送一帧数据的格式如图所示，其中1位起始位，8位数据位，1位停止位。（发送与接收都是先低位再高位）
[![](http://112.124.31.67/wp-content/uploads/2020/07/wp_editor_md_9d82e4e20d3a7794819b3db9cb1e662a.jpg)](http://112.124.31.67/wp-content/uploads/2020/07/wp_editor_md_9d82e4e20d3a7794819b3db9cb1e662a.jpg)
接收完9位数据后，前8位进入接收SBUF，第9位进入RB8,并置RI=1，向CPU请求中断


>方式2，3 
类似方式1，不过数据变成了11位


>SM2 多机通信控制位

主要用于方式2和方式3.
当接收机的SM2=1时可以利用接收到的RB8来控制是否激活RI。（RB8=0的话不激活RI，收到的信息被丢弃）当SM2=0时，不论RB8是什么，都可以收到数据，并且激活RI。

>REN 允许串口接收位

软件置1，则启动串口接收数据。若置0，则禁止接收数据

>TB8 RB8 在方式2或方式3中，分别是发送数据和接收数据的第九位

作为一些校验位
>TI 发送中断标志位

在方式0中，当串行发送第8位数据结束时，或在其它的方式时，串行发送口停止位的开始时，由内部硬件置1，向CPU发送中断申请。在中断服务中，必须用软件将其清0，取消此中断申请

>RI 接收中断标志位

在方式0中，当串行接收第8位数据结束时，或在其它的方式时，串行接收口停止位的中间时，由内部硬件置1，向CPU发送中断申请。在中断服务中，必须用软件将其清0，取消此中断申请

### 三、PCON寄存器
PCON中仅有一位SMOD与串行口工作有关：
[![](http://112.124.31.67/wp-content/uploads/2020/07/wp_editor_md_bd532082951879fd8a259f03bc303c5a.jpg)](http://112.124.31.67/wp-content/uploads/2020/07/wp_editor_md_bd532082951879fd8a259f03bc303c5a.jpg)

>SMOD(PCON.7) 波特率倍增位

在串行口方式1，2，3时，波特率与SMOD有关，当SMOD=1时，波特率提高一倍。复位时，SMOD=0.

### 三、波特率的计算
在串行通信中，收发双方对发送数据或是接收数据的速率是有约定的。方式0和方式2的波特率是固定的，1和3的波特率是可变的，由定时器T1的溢出率来决定。
[![](http://112.124.31.67/wp-content/uploads/2020/07/wp_editor_md_bd057ea7e97e7e66901fd611153fa366.jpg)](http://112.124.31.67/wp-content/uploads/2020/07/wp_editor_md_bd057ea7e97e7e66901fd611153fa366.jpg)

当T1作为波特率发生器时，最典型的用法是使T1工作在自动再装入的8位定时器方式，这时的溢出率却决于TH1中的计数值。
~~~c
T1溢出率=fosc/{12*[256-TH1]}
~~~
下面是常用的配置：
[![](http://112.124.31.67/wp-content/uploads/2020/07/wp_editor_md_058295a9ead85b62f186cf402d2aff5f.jpg)](http://112.124.31.67/wp-content/uploads/2020/07/wp_editor_md_058295a9ead85b62f186cf402d2aff5f.jpg)

### 四、串口的使用流程
* 确定T1的工作方式（编程TMOD寄存器）
* 计算T1的初值，装载TH1,TL1
* 启动T1(编程TCON中的TR位)
* 确定串行口控制（编程SCON寄存器）
* 串行口的中断设置（编程IE,IP寄存器）

*2020/7/4 17:57*
